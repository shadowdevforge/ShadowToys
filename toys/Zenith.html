<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Zenith // Flow</title>
  <meta name="theme-color" content="#1e1e2e">

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=JetBrains+Mono:wght@500&display=swap"
    rel="stylesheet">
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <!-- SortableJS for Touch-Friendly Drag and Drop -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

  <style>
    /* --- THEME: Catppuccin Mocha --- */
    :root {
      --base: #1e1e2e;
      --mantle: #181825;
      --crust: #11111b;
      --text: #cdd6f4;
      --subtext: #a6adc8;
      --overlay: #6c7086;
      --surface0: #313244;
      --surface1: #45475a;
      --surface2: #585b70;
      --mauve: #cba6f7;
      --blue: #89b4fa;
      --red: #f38ba8;
      --peach: #fab387;
      --green: #a6e3a1;
      --yellow: #f9e2af;

      --font-ui: 'Inter', sans-serif;
      --radius: 12px;
      --shadow: 0 4px 24px -6px rgba(0, 0, 0, 0.5);
      --ease: cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      outline: none;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      background: var(--base);
      color: var(--text);
      font-family: var(--font-ui);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* --- HEADER --- */
    header {
      height: 60px;
      padding: 0 20px;
      background: rgba(24, 24, 37, 0.8);
      border-bottom: 1px solid var(--surface0);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      z-index: 10;
    }

    .brand {
      font-weight: 900;
      font-size: 1.2rem;
      letter-spacing: -0.5px;
      color: var(--mauve);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .actions {
      display: flex;
      gap: 8px;
    }

    .btn {
      background: var(--surface0);
      border: none;
      color: var(--text);
      height: 36px;
      padding: 0 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s;
    }

    .btn:hover {
      background: var(--surface1);
    }

    .btn-primary {
      background: var(--mauve);
      color: var(--base);
    }

    .btn-primary:hover {
      background: #dcc1ff;
    }

    .btn-icon {
      width: 36px;
      padding: 0;
      justify-content: center;
      font-size: 1.2rem;
    }

    /* --- BOARD --- */
    .board {
      flex: 1;
      overflow-x: auto;
      overflow-y: hidden;
      display: flex;
      gap: 16px;
      padding: 20px;
      scroll-snap-type: x mandatory;
    }

    .column {
      background: var(--mantle);
      border: 1px solid var(--surface0);
      min-width: 300px;
      max-width: 300px;
      border-radius: var(--radius);
      display: flex;
      flex-direction: column;
      max-height: 100%;
      scroll-snap-align: center;
      transition: border-color 0.2s;
    }

    .column:focus-within {
      border-color: var(--surface2);
    }

    .col-header {
      padding: 16px;
      font-weight: 700;
      color: var(--subtext);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: grab;
    }

    .col-count {
      background: var(--surface0);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      color: var(--text);
    }

    .col-body {
      flex: 1;
      overflow-y: auto;
      padding: 0 12px 12px 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* SortableJS Ghost Class */
    .sortable-ghost {
      opacity: 0.4;
      background: var(--surface1);
      border: 2px dashed var(--overlay);
    }

    .sortable-drag {
      cursor: grabbing;
      opacity: 1;
      transform: scale(1.02);
      box-shadow: var(--shadow);
    }

    /* --- CARDS --- */
    .card {
      background: var(--surface0);
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      border: 1px solid transparent;
      transition: transform 0.2s, border-color 0.2s;
      position: relative;
      group;
    }

    .card:hover {
      border-color: var(--surface2);
      transform: translateY(-2px);
    }

    .card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    .tag {
      font-size: 0.65rem;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: uppercase;
    }

    .card-text {
      font-size: 0.95rem;
      line-height: 1.4;
      color: var(--text);
      word-wrap: break-word;
    }

    /* Tag Colors */
    .tag-high {
      background: rgba(243, 139, 168, 0.15);
      color: var(--red);
    }

    .tag-med {
      background: rgba(250, 179, 135, 0.15);
      color: var(--peach);
    }

    .tag-low {
      background: rgba(137, 180, 250, 0.15);
      color: var(--blue);
    }

    .tag-dev {
      background: rgba(166, 227, 161, 0.15);
      color: var(--green);
    }

    .add-card-btn {
      margin: 0 12px 12px 12px;
      padding: 10px;
      background: transparent;
      border: 1px dashed var(--surface2);
      border-radius: 8px;
      color: var(--subtext);
      cursor: pointer;
      transition: 0.2s;
      font-size: 0.9rem;
    }

    .add-card-btn:hover {
      background: var(--surface0);
      color: var(--text);
      border-color: var(--text);
    }

    /* --- MODALS --- */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }

    .modal-overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    .modal {
      background: var(--mantle);
      width: 90%;
      max-width: 500px;
      border-radius: var(--radius);
      border: 1px solid var(--surface1);
      padding: 24px;
      box-shadow: var(--shadow);
      transform: translateY(20px);
      transition: transform 0.2s;
    }

    .modal-overlay.open .modal {
      transform: translateY(0);
    }

    .modal-header {
      font-size: 1.2rem;
      font-weight: 800;
      margin-bottom: 20px;
      color: var(--text);
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 0.85rem;
      color: var(--subtext);
      margin-bottom: 6px;
    }

    input,
    textarea,
    select {
      width: 100%;
      background: var(--base);
      border: 1px solid var(--surface0);
      color: var(--text);
      padding: 10px;
      border-radius: 8px;
      font-family: inherit;
      resize: none;
      transition: border-color 0.2s;
    }

    input:focus,
    textarea:focus {
      border-color: var(--mauve);
    }

    .modal-footer {
      display: flex;
      justify-content: space-between;
      margin-top: 24px;
    }

    .flex-right {
      display: flex;
      gap: 10px;
    }

    /* Mobile specific adjustments */
    @media (max-width: 600px) {
      .column {
        min-width: 85vw;
        max-width: 85vw;
      }

      .board {
        padding: 10px;
        gap: 10px;
      }
    }
  </style>
</head>

<body>

  <header>
    <div class="brand">
      <i class="ph-fill ph-kanban"></i> Zenith // Flow
    </div>
    <div class="actions">
      <button class="btn btn-icon" onclick="App.exportData()" title="Export JSON"><i
          class="ph-bold ph-download-simple"></i></button>
      <button class="btn btn-icon" onclick="document.getElementById('importFile').click()" title="Import JSON"><i
          class="ph-bold ph-upload-simple"></i></button>
      <button class="btn btn-icon" onclick="App.clearData()" title="Reset Board"><i
          class="ph-bold ph-trash"></i></button>
      <input type="file" id="importFile" style="display:none" onchange="App.importData(this)">
    </div>
  </header>

  <div class="board" id="board">
    <!-- Columns Injected Here -->
  </div>

  <!-- Edit/Add Modal -->
  <div class="modal-overlay" id="cardModal">
    <div class="modal">
      <div class="modal-header" id="modalTitle">Edit Card</div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea id="cardText" rows="4" placeholder="What needs to be done?"></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Priority / Tag</label>
        <select id="cardTag">
          <option value="">None</option>
          <option value="tag-high">High Priority</option>
          <option value="tag-med">Medium Priority</option>
          <option value="tag-low">Low Priority</option>
          <option value="tag-dev">Development</option>
        </select>
      </div>
      <div class="modal-footer">
        <button class="btn" style="color: var(--red)" onclick="App.deleteCard()" id="btnDelete">Delete</button>
        <div class="flex-right">
          <button class="btn" onclick="UI.closeModal()">Cancel</button>
          <button class="btn btn-primary" onclick="App.saveCard()">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /**
     * ZENITH FLOW ENGINE
     * Architecture: Singleton State + SortableJS Integration
     */

    const STORAGE_KEY = 'zenith_flow_v1';

    const State = {
      data: {
        columns: [
          {id: 'c1', title: 'To Do', cards: []},
          {id: 'c2', title: 'In Progress', cards: []},
          {id: 'c3', title: 'Done', cards: []}
        ]
      },

      // Tracking active edits
      editing: {colId: null, cardId: null},

      load() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          try {this.data = JSON.parse(raw);}
          catch (e) {console.error('Data corrupted, resetting');}
        }
        // Ensure structure validity
        if (!this.data.columns) this.reset();
      },

      save() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(this.data));
      },

      reset() {
        this.data = {
          columns: [
            {id: 'c1', title: 'To Do', cards: [{id: 't1', text: 'Welcome to Zenith', tag: 'tag-dev'}, {id: 't2', text: 'Drag me around!', tag: 'tag-high'}]},
            {id: 'c2', title: 'In Progress', cards: []},
            {id: 'c3', title: 'Done', cards: []}
          ]
        };
        this.save();
      }
    };

    const UI = {
      board: document.getElementById('board'),
      modal: document.getElementById('cardModal'),

      init() {
        this.render();
      },

      render() {
        this.board.innerHTML = '';
        State.data.columns.forEach(col => {
          const colEl = document.createElement('div');
          colEl.className = 'column';
          colEl.dataset.id = col.id;

          // Header
          colEl.innerHTML = `
                <div class="col-header">
                    ${col.title}
                    <span class="col-count">${col.cards.length}</span>
                </div>
                <div class="col-body" id="list-${col.id}"></div>
                <button class="add-card-btn" onclick="App.openAdd('${col.id}')">+ Add Card</button>
            `;

          const listEl = colEl.querySelector('.col-body');

          // Render Cards
          col.cards.forEach(card => {
            const cardEl = document.createElement('div');
            cardEl.className = 'card';
            cardEl.dataset.id = card.id;
            cardEl.onclick = () => App.openEdit(col.id, card.id);

            // Tag HTML
            let tagHtml = '';
            if (card.tag) {
              const labels = {'tag-high': 'High', 'tag-med': 'Medium', 'tag-low': 'Low', 'tag-dev': 'Dev'};
              tagHtml = `<div class="card-tags"><span class="tag ${card.tag}">${labels[card.tag] || 'Tag'}</span></div>`;
            }

            cardEl.innerHTML = `
                    ${tagHtml}
                    <div class="card-text">${this.escape(card.text)}</div>
                `;
            listEl.appendChild(cardEl);
          });

          // Init Sortable for this column
          new Sortable(listEl, {
            group: 'zenith', // Allow dragging between columns
            animation: 150,
            delay: 100, // Slight delay prevents accidental drags on touch scroll
            delayOnTouchOnly: true,
            ghostClass: 'sortable-ghost',
            dragClass: 'sortable-drag',
            onEnd: (evt) => {
              App.handleDrag(evt.from, evt.to, evt.oldIndex, evt.newIndex, evt.item.dataset.id);
            }
          });

          this.board.appendChild(colEl);
        });
      },

      openModal(title, text = '', tag = '') {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('cardText').value = text;
        document.getElementById('cardTag').value = tag;
        this.modal.classList.add('open');
        setTimeout(() => document.getElementById('cardText').focus(), 100);
      },

      closeModal() {
        this.modal.classList.remove('open');
        State.editing = {colId: null, cardId: null};
      },

      escape(str) {
        if (!str) return '';
        return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
      }
    };

    const App = {
      init() {
        State.load();
        UI.init();
      },

      // Drag Logic
      handleDrag(fromEl, toEl, oldIdx, newIdx, cardId) {
        const fromColId = fromEl.closest('.column').dataset.id;
        const toColId = toEl.closest('.column').dataset.id;

        const fromCol = State.data.columns.find(c => c.id === fromColId);
        const toCol = State.data.columns.find(c => c.id === toColId);

        // Find and remove card
        const card = fromCol.cards.splice(oldIdx, 1)[0];

        // Insert into new pos
        toCol.cards.splice(newIdx, 0, card);

        State.save();
        // Re-render only counts? For simplicity, we re-render board to update counts
        // In a huge app we'd update DOM directly, but for <500 cards this is fine.
        UI.render();
      },

      // CRUD
      openAdd(colId) {
        State.editing = {colId, cardId: null};
        document.getElementById('btnDelete').style.display = 'none';
        UI.openModal('Add New Card');
      },

      openEdit(colId, cardId) {
        State.editing = {colId, cardId};
        const col = State.data.columns.find(c => c.id === colId);
        const card = col.cards.find(c => c.id === cardId);

        document.getElementById('btnDelete').style.display = 'block';
        UI.openModal('Edit Card', card.text, card.tag);
      },

      saveCard() {
        const text = document.getElementById('cardText').value.trim();
        const tag = document.getElementById('cardTag').value;
        if (!text) return;

        const {colId, cardId} = State.editing;
        const col = State.data.columns.find(c => c.id === colId);

        if (cardId) {
          // Update
          const card = col.cards.find(c => c.id === cardId);
          card.text = text;
          card.tag = tag;
        } else {
          // Create
          col.cards.push({
            id: 't' + Date.now(),
            text: text,
            tag: tag
          });
        }

        State.save();
        UI.closeModal();
        UI.render();
      },

      deleteCard() {
        if (!confirm('Delete this card?')) return;
        const {colId, cardId} = State.editing;
        const col = State.data.columns.find(c => c.id === colId);
        col.cards = col.cards.filter(c => c.id !== cardId);

        State.save();
        UI.closeModal();
        UI.render();
      },

      // Data Management
      exportData() {
        const str = JSON.stringify(State.data, null, 2);
        const blob = new Blob([str], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `zenith_board_${Date.now()}.json`;
        a.click();
      },

      importData(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const json = JSON.parse(e.target.result);
            if (json.columns && Array.isArray(json.columns)) {
              if (confirm('This will overwrite your current board. Continue?')) {
                State.data = json;
                State.save();
                UI.render();
              }
            } else {
              alert('Invalid file format');
            }
          } catch (err) {
            alert('Error parsing JSON');
          }
        };
        reader.readAsText(file);
        input.value = ''; // Reset
      },

      clearData() {
        if (confirm('Are you sure you want to wipe the board?')) {
          State.reset();
          UI.render();
        }
      }
    };

    // Start
    App.init();

  </script>
</body>

</html>
